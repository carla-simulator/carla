#! /bin/bash

# ==============================================================================
# -- Parse arguments -----------------------------------------------------------
# ==============================================================================

DOC_STRING="Download and install the required libraries for carla."

USAGE_STRING="Usage: $0 [--python-version=VERSION]"

OPTS=`getopt -o h --long help,chrono,ros2,pytorch,python-version: -n 'parse-options' -- "$@"`

eval set -- "$OPTS"

PY_VERSION_LIST=3
USE_CHRONO=false
USE_PYTORCH=false
USE_ROS2=false

while [[ $# -gt 0 ]]; do
  case "$1" in
    --python-version )
      PY_VERSION_LIST="$2";
      shift 2 ;;
    --chrono )
      USE_CHRONO=true;
      shift ;;
    --pytorch )
      USE_PYTORCH=true;
      shift ;;
    --ros2 )
      USE_ROS2=true;
      shift ;;
    -h | --help )
      echo "$DOC_STRING"
      echo "$USAGE_STRING"
      exit 1
      ;;
    * )
      shift ;;
  esac
done

# ==============================================================================
# -- Set up environment --------------------------------------------------------
# ==============================================================================

source $(dirname "$0")/Environment.sh

export CC="$UE4_ROOT/Engine/Extras/ThirdPartyNotUE/SDKs/HostLinux/Linux_x64/v17_clang-10.0.1-centos7/x86_64-unknown-linux-gnu/bin/clang"
export CXX="$UE4_ROOT/Engine/Extras/ThirdPartyNotUE/SDKs/HostLinux/Linux_x64/v17_clang-10.0.1-centos7/x86_64-unknown-linux-gnu/bin/clang++"
export PATH="$UE4_ROOT/Engine/Extras/ThirdPartyNotUE/SDKs/HostLinux/Linux_x64/v17_clang-10.0.1-centos7/x86_64-unknown-linux-gnu/bin:$PATH"

CXX_TAG=c10

# Convert comma-separated string to array of unique elements.
IFS="," read -r -a PY_VERSION_LIST <<< "${PY_VERSION_LIST}"

mkdir -p ${CARLA_BUILD_FOLDER}
pushd ${CARLA_BUILD_FOLDER} >/dev/null

LLVM_INCLUDE="$UE4_ROOT/Engine/Source/ThirdParty/Linux/LibCxx/include/c++/v1"
LLVM_LIBPATH="$UE4_ROOT/Engine/Source/ThirdParty/Linux/LibCxx/lib/Linux/x86_64-unknown-linux-gnu"
UNREAL_HOSTED_CFLAGS="--sysroot=$UE4_ROOT/Engine/Extras/ThirdPartyNotUE/SDKs/HostLinux/Linux_x64/v17_clang-10.0.1-centos7/x86_64-unknown-linux-gnu/ -isystem ${LLVM_INCLUDE}"
UNREAL_SYSTEM_LIBPATH="$UE4_ROOT/Engine/Extras/ThirdPartyNotUE/SDKs/HostLinux/Linux_x64/v17_clang-10.0.1-centos7/x86_64-unknown-linux-gnu/usr/lib"
UNREAL_HOSTED_LINKER_FLAGS="--sysroot=$UE4_ROOT/Engine/Extras/ThirdPartyNotUE/SDKs/HostLinux/Linux_x64/v17_clang-10.0.1-centos7/x86_64-unknown-linux-gnu/ -L${LLVM_LIBPATH} -L${UNREAL_SYSTEM_LIBPATH} -lc++ -lc++abi"


# ==============================================================================
# -- Generate Version.h --------------------------------------------------------
# ==============================================================================

CARLA_VERSION=$(get_git_repository_version)

log "CARLA version ${CARLA_VERSION}."

VERSION_H_FILE=${LIBCARLA_ROOT_FOLDER}/source/carla/Version.h
VERSION_H_FILE_GEN=${CARLA_BUILD_FOLDER}/Version.h

sed -e "s|\${CARLA_VERSION}|${CARLA_VERSION}|g" ${VERSION_H_FILE}.in > ${VERSION_H_FILE_GEN}

move_if_changed "${VERSION_H_FILE_GEN}" "${VERSION_H_FILE}"

# ==============================================================================
# -- Generate CMake toolchains and config --------------------------------------
# ==============================================================================

log "Generating CMake configuration files."

# -- LIBSTDCPP_TOOLCHAIN_FILE --------------------------------------------------

cat >${LIBSTDCPP_TOOLCHAIN_FILE}.gen <<EOL
# Automatically generated by `basename "$0"`

set(CMAKE_C_COMPILER ${CC})
set(CMAKE_CXX_COMPILER ${CXX})

# disable -Werror since the boost 1.72 doesn't compile with ad_rss without warnings (i.e. the geometry headers)
set(CMAKE_C_FLAGS "\${CMAKE_C_FLAGS} -fPIC" CACHE STRING "" FORCE)
set(CMAKE_CXX_FLAGS "\${CMAKE_CXX_FLAGS} -std=c++17 -pthread -fPIC" CACHE STRING "" FORCE)
set(CMAKE_CXX_FLAGS "\${CMAKE_CXX_FLAGS} -Wall -Wextra -Wpedantic" CACHE STRING "" FORCE)
set(CMAKE_CXX_FLAGS "\${CMAKE_CXX_FLAGS} -Wdeprecated -Wshadow -Wuninitialized -Wunreachable-code" CACHE STRING "" FORCE)
set(CMAKE_CXX_FLAGS "\${CMAKE_CXX_FLAGS} -Wpessimizing-move -Wold-style-cast -Wnull-dereference" CACHE STRING "" FORCE)
set(CMAKE_CXX_FLAGS "\${CMAKE_CXX_FLAGS} -Wduplicate-enum -Wnon-virtual-dtor -Wheader-hygiene" CACHE STRING "" FORCE)
set(CMAKE_CXX_FLAGS "\${CMAKE_CXX_FLAGS} -Wconversion -Wfloat-overflow-conversion" CACHE STRING "" FORCE)

# @todo These flags need to be compatible with setup.py compilation.
set(CMAKE_CXX_FLAGS_RELEASE_CLIENT "\${CMAKE_CXX_FLAGS_RELEASE} -DNDEBUG -g -fwrapv -O2 -Wall -Wstrict-prototypes -fno-strict-aliasing -Wdate-time -D_FORTIFY_SOURCE=2 -g -fstack-protector-strong -Wformat -Werror=format-security -fPIC -std=c++17 -Wno-missing-braces -DBOOST_ERROR_CODE_HEADER_ONLY" CACHE STRING "" FORCE)
EOL

# -- LIBCPP_TOOLCHAIN_FILE -----------------------------------------------------

# We can reuse the previous toolchain.
cp ${LIBSTDCPP_TOOLCHAIN_FILE}.gen ${LIBCPP_TOOLCHAIN_FILE}.gen

cat >>${LIBCPP_TOOLCHAIN_FILE}.gen <<EOL

set(BUILD_STATIC_LIBS ON)
set(BUILD_SHARED_LIBS OFF)
set(CMAKE_C_FLAGS "\${CMAKE_C_FLAGS} -fPIC" CACHE STRING "" FORCE)
set(CMAKE_C_FLAGS "\${CMAKE_C_FLAGS} ${UNREAL_HOSTED_CFLAGS}" CACHE STRING "" FORCE)
set(CMAKE_CXX_FLAGS "\${CMAKE_CXX_FLAGS} -std=c++17 -fPIC -stdlib=libc++ -DBOOST_NO_EXCEPTIONS -DASIO_NO_EXCEPTIONS" CACHE STRING "" FORCE)
set(CMAKE_CXX_FLAGS "\${CMAKE_CXX_FLAGS} ${UNREAL_HOSTED_CFLAGS}" CACHE STRING "" FORCE)
set(CMAKE_SHARED_LINKER_FLAGS "\${CMAKE_SHARED_LINKER_FLAGS} ${UNREAL_HOSTED_LINKER_FLAGS}" CACHE STRING "" FORCE)
set(CMAKE_EXE_LINKER_FLAGS "\${CMAKE_EXE_LINKER_FLAGS} ${UNREAL_HOSTED_LINKER_FLAGS}" CACHE STRING "" FORCE)
set(CMAKE_INSTALL_RPATH "\$ORIGIN/../../CarlaDependencies/lib")
set(CMAKE_BUILD_RPATH_USE_ORIGIN True)

EOL

move_if_changed "${LIBCPP_TOOLCHAIN_FILE}.gen" "${LIBCPP_TOOLCHAIN_FILE}"
move_if_changed "${LIBSTDCPP_TOOLCHAIN_FILE}.gen" "${LIBSTDCPP_TOOLCHAIN_FILE}"


mkdir -p "${LIBCARLA_INSTALL_SERVER_FOLDER}/lib/"
mkdir -p "${LIBCARLA_INSTALL_SERVER_FOLDER}/include/"
mkdir -p "${LIBCARLA_INSTALL_CLIENT_FOLDER}/include/system"
mkdir -p "${LIBCARLA_INSTALL_CLIENT_FOLDER}/lib"
mkdir -p "${LIBCARLA_INSTALL_CLIENT_FOLDER}/bin/"

# Install libc++ libraries.
cp ${LLVM_LIBPATH}/libc++*.a "${LIBCARLA_INSTALL_SERVER_FOLDER}/lib/"

# Install UE shared dependencies
cp -p ${UNREAL_SYSTEM_LIBPATH}/lib${libName}*.so* "${LIBCARLA_INSTALL_SERVER_FOLDER}/lib/"

# ==============================================================================
# -- Get boost includes --------------------------------------------------------
# ==============================================================================

BOOST_VERSION=1.80.0
BOOST_BASENAME="boost-${BOOST_VERSION}-${CXX_TAG}"
BOOST_SHA256SUM="4b2136f98bdd1f5857f1c3dea9ac2018effe65286cf251534b6ae20cc45e1847"

BOOST_INCLUDE=${PWD}/${BOOST_BASENAME}-install/include
BOOST_LIBPATH=${PWD}/${BOOST_BASENAME}-install/lib

for PY_VERSION in ${PY_VERSION_LIST[@]} ; do
  SHOULD_BUILD_BOOST=true
  PYTHON_VERSION=$(/usr/bin/env python${PY_VERSION} -V 2>&1)
  LIB_NAME=$(cut -d . -f 1,2 <<< "$PYTHON_VERSION" | tr -d .)
  LIB_NAME=${LIB_NAME:7}
  if [[ -d "${BOOST_BASENAME}-install" ]] ; then
    if [ -f "${BOOST_BASENAME}-install/lib/libboost_python${LIB_NAME}.a" ] ; then
      SHOULD_BUILD_BOOST=false
      log "${BOOST_BASENAME} already installed."
    fi
  fi

  if { ${SHOULD_BUILD_BOOST} ; } ; then
    rm -Rf ${BOOST_BASENAME}-source

    BOOST_PACKAGE_BASENAME=boost_${BOOST_VERSION//./_}

    log "Retrieving boost."

    start=$(date +%s)
    wget "https://archives.boost.io/release/${BOOST_VERSION}/source/${BOOST_PACKAGE_BASENAME}.tar.gz" || true
    end=$(date +%s)
    echo "Elapsed Time downloading from boost webpage: $(($end-$start)) seconds"

    # try to use the backup boost we have in Jenkins
    if [ ! -f "${BOOST_PACKAGE_BASENAME}.tar.gz" ] || [[ $(sha256sum "${BOOST_PACKAGE_BASENAME}.tar.gz") != "${BOOST_SHA256SUM}" ]] ; then
      log "Using boost backup"

      start=$(date +%s)
      wget "https://carla-releases.s3.us-east-005.backblazeb2.com/Backup/${BOOST_PACKAGE_BASENAME}.tar.gz" || true
      end=$(date +%s)
      echo "Elapsed Time downloading from boost carla backup in backblaze: $(($end-$start)) seconds"

    fi

    log "Extracting boost for Python ${PY_VERSION}."

    start=$(date +%s)
    tar -xzf ${BOOST_PACKAGE_BASENAME}.tar.gz
    end=$(date +%s)
    echo "Elapsed Time Extracting boost for Python: $(($end-$start)) seconds"

    mkdir -p ${BOOST_BASENAME}-install/include
    mv ${BOOST_PACKAGE_BASENAME} ${BOOST_BASENAME}-source

    pushd ${BOOST_BASENAME}-source >/dev/null

    BOOST_TOOLSET="clang-10.0"
    BOOST_CFLAGS="-fPIC -std=c++17 -DBOOST_ERROR_CODE_HEADER_ONLY"

    py3="/usr/bin/env python${PY_VERSION}"
    py3_root=`${py3} -c "import sys; print(sys.prefix)"`
    pyv=`$py3 -c "import sys;x='{v[0]}.{v[1]}'.format(v=list(sys.version_info[:2]));sys.stdout.write(x)";`
    ./bootstrap.sh \
        --with-toolset=clang \
        --prefix=../boost-install \
        --with-libraries=python,filesystem,system,program_options \
        --with-python=${py3} --with-python-root=${py3_root}

    if ${TRAVIS} ; then
      echo "using python : ${pyv} : ${py3_root}/bin/python${PY_VERSION} ;" > ${HOME}/user-config.jam
    else
      echo "using python : ${pyv} : ${py3_root}/bin/python${PY_VERSION} ;" > project-config.jam
    fi

    ./b2 toolset="${BOOST_TOOLSET}" cxxflags="${BOOST_CFLAGS}" --prefix="../${BOOST_BASENAME}-install" -j ${CARLA_BUILD_CONCURRENCY} stage release
    ./b2 toolset="${BOOST_TOOLSET}" cxxflags="${BOOST_CFLAGS}" --prefix="../${BOOST_BASENAME}-install" -j ${CARLA_BUILD_CONCURRENCY} install

    popd >/dev/null

    rm -Rf ${BOOST_BASENAME}-source
    rm ${BOOST_PACKAGE_BASENAME}.tar.gz

    # Install boost dependencies
    cp -rf ${BOOST_BASENAME}-install/include/* ${LIBCARLA_INSTALL_CLIENT_FOLDER}/include/system
    cp -rf ${BOOST_BASENAME}-install/lib/* ${LIBCARLA_INSTALL_CLIENT_FOLDER}/lib

  fi

done

unset BOOST_BASENAME


# ==============================================================================
# -- Get rpclib and compile it for server (libc++) and client (libstdc++) ------
# ==============================================================================

RPCLIB_PATCH=v2.2.1_c5
RPCLIB_BASENAME=rpclib-${RPCLIB_PATCH}-${CXX_TAG}

RPCLIB_SERVER_INCLUDE=${PWD}/${RPCLIB_BASENAME}-server-install/include
RPCLIB_SERVER_LIBPATH=${PWD}/${RPCLIB_BASENAME}-server-install/lib
RPCLIB_CLIENT_INCLUDE=${PWD}/${RPCLIB_BASENAME}-client-install/include
RPCLIB_CLIENT_LIBPATH=${PWD}/${RPCLIB_BASENAME}-client-install/lib

if [[ -d "${RPCLIB_BASENAME}-server-install" && -d "${RPCLIB_BASENAME}-client-install" ]] ; then
  log "${RPCLIB_BASENAME} already installed."
else
  rm -Rf \
      ${RPCLIB_BASENAME}-source \
      ${RPCLIB_BASENAME}-server-build ${RPCLIB_BASENAME}-client-build \
      ${RPCLIB_BASENAME}-server-install ${RPCLIB_BASENAME}-client-install

  log "Retrieving rpclib."

  start_download_time=$(date +%s)

  git clone -b ${RPCLIB_PATCH} https://github.com/carla-simulator/rpclib.git ${RPCLIB_BASENAME}-source

  end_download_time=$(date +%s)
  echo "Elapsed Time downloading rpclib: $(($end_download_time-$start_download_time)) seconds"
  log "Building rpclib for server (libc++)."

  # rpclib does not use any cmake 3.9 feature.
  # As cmake 3.9 is not standard in Ubuntu 16.04, change cmake version to 3.5
  sed -i s/"3.9.0"/"3.5.0"/g ${RPCLIB_BASENAME}-source/CMakeLists.txt

  mkdir -p ${RPCLIB_BASENAME}-server-build
  pushd ${RPCLIB_BASENAME}-server-build >/dev/null
  cmake -G "Ninja" \
      -DCMAKE_INSTALL_PREFIX="../${RPCLIB_BASENAME}-server-install" \
      -DCMAKE_TOOLCHAIN_FILE="${LIBCPP_TOOLCHAIN_FILE}" \
      ../${RPCLIB_BASENAME}-source
  ninja
  ninja install
  popd >/dev/null

  log "Building rpclib for client (libstdc++)."
  mkdir -p ${RPCLIB_BASENAME}-client-build
  pushd ${RPCLIB_BASENAME}-client-build >/dev/null
  cmake -G "Ninja" \
      -DCMAKE_CXX_FLAGS="-fPIC -std=c++17" \
      -DCMAKE_INSTALL_PREFIX="../${RPCLIB_BASENAME}-client-install" \
      ../${RPCLIB_BASENAME}-source
  ninja
  ninja install
  popd >/dev/null

  rm -Rf ${RPCLIB_BASENAME}-source ${RPCLIB_BASENAME}-server-build ${RPCLIB_BASENAME}-client-build
fi

unset RPCLIB_BASENAME

cp -p -r ${RPCLIB_SERVER_INCLUDE}/* ${LIBCARLA_INSTALL_SERVER_FOLDER}/include/
cp -p ${RPCLIB_SERVER_LIBPATH}/*.a ${LIBCARLA_INSTALL_SERVER_FOLDER}/lib

# ==============================================================================
# -- Get GTest and compile it for server (libc++) --------------------------------------
# ==============================================================================

GTEST_VERSION=1.8.1
GTEST_BASENAME=gtest-${GTEST_VERSION}-${CXX_TAG}

GTEST_SERVER_INCLUDE=${PWD}/${GTEST_BASENAME}-server-install/include
GTEST_SERVER_LIBPATH=${PWD}/${GTEST_BASENAME}-server-install/lib
GTEST_CLIENT_INCLUDE=${PWD}/${GTEST_BASENAME}-client-install/include
GTEST_CLIENT_LIBPATH=${PWD}/${GTEST_BASENAME}-client-install/lib

if [[ -d "${GTEST_BASENAME}-server-install" && -d "${GTEST_BASENAME}-client-install" ]] ; then
  log "${GTEST_BASENAME} already installed."
else
  rm -Rf \
      ${GTEST_BASENAME}-source \
      ${GTEST_BASENAME}-server-build ${GTEST_BASENAME}-client-build \
      ${GTEST_BASENAME}-server-install ${GTEST_BASENAME}-client-install

  log "Retrieving Google Test."

  start_download_time=$(date +%s)

  git clone --depth=1 -b release-${GTEST_VERSION} https://github.com/google/googletest.git ${GTEST_BASENAME}-source

  end_download_time=$(date +%s)
  echo "Elapsed Time downloading rpclib: $(($end_download_time-$start_download_time)) seconds"

  log "Building Google Test for server (libc++)."

  mkdir -p ${GTEST_BASENAME}-server-build
  pushd ${GTEST_BASENAME}-server-build >/dev/null

  cmake -G "Ninja" \
      -DCMAKE_INSTALL_PREFIX="../${GTEST_BASENAME}-server-install" \
      -DCMAKE_TOOLCHAIN_FILE="${LIBCPP_TOOLCHAIN_FILE}" \
      ../${GTEST_BASENAME}-source
  ninja
  ninja install
  popd >/dev/null

  log "Building Google Test for client (libstdc++)."
  mkdir -p ${GTEST_BASENAME}-client-build
  pushd ${GTEST_BASENAME}-client-build >/dev/null
  cmake -G "Ninja" \
      -DCMAKE_CXX_FLAGS="-std=c++17" \
      -DCMAKE_INSTALL_PREFIX="../${GTEST_BASENAME}-client-install" \
      ../${GTEST_BASENAME}-source
  ninja
  ninja install
  popd >/dev/null

  rm -Rf ${GTEST_BASENAME}-source ${GTEST_BASENAME}-server-build ${GTEST_BASENAME}-client-build
fi

unset GTEST_BASENAME

# ==============================================================================
# -- Get Recast&Detour and compile it for client (libstdc++) ------------------------------
# ==============================================================================

RECAST_BASENAME=recast-${CXX_TAG}

RECAST_CLIENT_INCLUDE=${PWD}/${RECAST_BASENAME}-client-install/include
RECAST_CLIENT_LIBPATH=${PWD}/${RECAST_BASENAME}-client-install/lib

if [[ -d "${RECAST_BASENAME}-client-install" &&
      -f "${RECAST_BASENAME}-client-install/bin/RecastBuilder" ]] ; then
  log "${RECAST_BASENAME} already installed."
else
  rm -Rf \
      ${RECAST_BASENAME}-source \
      ${RECAST_BASENAME}-client-build \
      ${RECAST_BASENAME}-client-install

  log "Retrieving Recast & Detour"

  start=$(date +%s)

  git clone --depth 1 -b carla https://github.com/carla-simulator/recastnavigation.git ${RECAST_BASENAME}-source

  end=$(date +%s)
  echo "Elapsed Time downloading: $(($end-$start)) seconds"

  pushd ${RECAST_BASENAME}-source >/dev/null

  popd >/dev/null

  log "Building Recast & Detour for client (libstdc++)."
  mkdir -p ${RECAST_BASENAME}-client-build
  pushd ${RECAST_BASENAME}-client-build >/dev/null
  cmake -G "Ninja" \
      -DCMAKE_CXX_FLAGS="-std=c++17 -fPIC" \
      -DCMAKE_INSTALL_PREFIX="../${RECAST_BASENAME}-client-install" \
      -DRECASTNAVIGATION_DEMO=False \
      -DRECASTNAVIGATION_TEST=False \
      ../${RECAST_BASENAME}-source
  ninja
  ninja install
  popd >/dev/null

  rm -Rf ${RECAST_BASENAME}-source ${RECAST_BASENAME}-client-build
fi

# make sure the RecastBuilder is corrctly copied
RECAST_INSTALL_CLIENT_DIR="${CARLA_BUILD_FOLDER}/../Util/DockerUtils/dist"
if [[ ! -f "${RECAST_INSTALL_CLIENT_DIR}/RecastBuilder" ]]; then
  cp "${RECAST_BASENAME}-client-install/bin/RecastBuilder" "${RECAST_INSTALL_CLIENT_DIR}/"
fi

unset RECAST_BASENAME

# ==============================================================================
# -- Get and compile libpng 1.6.37 ------------------------------
# ==============================================================================

LIBPNG_VERSION=1.6.37
LIBPNG_REPO=https://sourceforge.net/projects/libpng/files/libpng16/${LIBPNG_VERSION}/libpng-${LIBPNG_VERSION}.tar.xz
LIBPNG_BASENAME=libpng-${LIBPNG_VERSION}

LIBPNG_CLIENT_INCLUDE=${PWD}/${LIBPNG_BASENAME}-client-install/include/
LIBPNG_CLIENT_LIBPATH=${PWD}/${LIBPNG_BASENAME}-client-install/lib

if [[ -d ${LIBPNG_BASENAME}-client-install ]] ; then
  log "Libpng already installed."
else
  rm -Rf \
      ${LIBPNG_BASENAME}-source \
      ${LIBPNG_BASENAME}-client-build \
      ${LIBPNG_BASENAME}-client-install

  log "Retrieving libpng."

  start=$(date +%s)
  wget ${LIBPNG_REPO}
  end=$(date +%s)
  echo "Elapsed Time downloading libpng: $(($end-$start)) seconds"

  start=$(date +%s)
  log "Extracting libpng."
  tar -xf libpng-${LIBPNG_VERSION}.tar.xz
  end=$(date +%s)
  echo "Elapsed Time Extracting libpng: $(($end-$start)) seconds"

  mv ${LIBPNG_BASENAME} ${LIBPNG_BASENAME}-source


  mkdir ${LIBPNG_BASENAME}-client-build
  pushd ${LIBPNG_BASENAME}-client-build >/dev/null
  ../${LIBPNG_BASENAME}-source/configure --prefix=${PWD}/../${LIBPNG_BASENAME}-client-install/
  make
  make install
  popd >/dev/null

  rm -Rf libpng-${LIBPNG_VERSION}.tar.xz
  rm -Rf ${LIBPNG_BASENAME}-source ${LIBPNG_BASENAME}-client-build
fi

# ==============================================================================
# -- Get and compile libxerces 3.2.3 ------------------------------
# ==============================================================================

XERCESC_VERSION=3.2.3
XERCESC_BASENAME=xerces-c-${XERCESC_VERSION}

XERCESC_TEMP_FOLDER=${XERCESC_BASENAME}
XERCESC_REPO=https://archive.apache.org/dist/xerces/c/3/sources/xerces-c-${XERCESC_VERSION}.tar.gz

XERCESC_CLIENT_LIB=${XERCESC_BASENAME}-client-install/lib/libxerces-c.a
XERCESC_SERVER_LIB=${XERCESC_BASENAME}-server-install/lib/libxerces-c.a

if [[ -d ${XERCESC_BASENAME}-client-install &&  -d ${XERCESC_BASENAME}-server-install ]] ; then
  log "Xerces-c already installed."
else
  rm -Rf \
      ${XERCESC_BASENAME}-source \
      ${XERCESC_BASENAME}-server-build ${XERCESC_BASENAME}-client-build \
      ${XERCESC_BASENAME}-server-install ${XERCESC_BASENAME}-client-install

  log "Retrieving xerces-c."
  start=$(date +%s)
  wget ${XERCESC_REPO}
  end=$(date +%s)
  echo "Elapsed Time downloading from xerces repo: $(($end-$start)) seconds"
  # try to use the backup boost we have in Jenkins
  if [[ ! -f "${XERCESC_BASENAME}.tar.gz" ]] ; then
    log "Using xerces backup"
    start=$(date +%s)
    wget "https://carla-releases.s3.us-east-005.backblazeb2.com/Backup/${XERCESC_BASENAME}.tar.gz" || true
    end=$(date +%s)
    echo "Elapsed Time downloading from xerces backup: $(($end-$start)) seconds"
  fi

  log "Extracting xerces-c."

  start=$(date +%s)
  tar -xzf ${XERCESC_BASENAME}.tar.gz
  end=$(date +%s)
  echo "Elapsed Time Extracting xerces-c: $(($end-$start)) seconds"

  mv ${XERCESC_BASENAME} ${XERCESC_BASENAME}-source

  log "Building xerces-c for server (libc++)."
  mkdir -p ${XERCESC_BASENAME}-server-build
  pushd ${XERCESC_BASENAME}-server-build >/dev/null
  cmake -G "Ninja" \
      -DCMAKE_INSTALL_PREFIX="../${XERCESC_BASENAME}-server-install" \
      -DCMAKE_TOOLCHAIN_FILE="${LIBCPP_TOOLCHAIN_FILE}" \
      -DCMAKE_BUILD_TYPE=Release \
      -DBUILD_SHARED_LIBS=OFF \
      -Dtranscoder=gnuiconv \
      -Dnetwork=OFF \
      ../${XERCESC_BASENAME}-source
  ninja
  ninja install
  popd >/dev/null

  log "Building xerces-c for client (libstdc++)."
  mkdir -p ${XERCESC_BASENAME}-client-build
  pushd ${XERCESC_BASENAME}-client-build >/dev/null

  cmake -G "Ninja" \
      -DCMAKE_CXX_FLAGS="-std=c++17 -fPIC -w" \
      -DCMAKE_INSTALL_PREFIX="../${XERCESC_BASENAME}-client-install" \
      -DCMAKE_BUILD_TYPE=Release \
      -DBUILD_SHARED_LIBS=OFF \
      -Dtranscoder=gnuiconv \
      -Dnetwork=OFF \
      ../${XERCESC_BASENAME}-source
  ninja
  ninja install
  popd >/dev/null

  rm -Rf ${XERCESC_BASENAME}.tar.gz
  rm -Rf ${XERCESC_BASENAME}-source ${XERCESC_BASENAME}-client-build ${XERCESC_BASENAME}-server-build
fi

cp ${XERCESC_CLIENT_LIB} ${LIBCARLA_INSTALL_CLIENT_FOLDER}/lib/
cp -p ${XERCESC_SERVER_LIB} ${LIBCARLA_INSTALL_SERVER_FOLDER}/lib/

# ==============================================================================
# -- Get Eigen headers 3.1.0 (CARLA dependency) -------------------------------------
# ==============================================================================

EIGEN_VERSION=3.1.0
EIGEN_REPO=https://gitlab.com/libeigen/eigen/-/archive/${EIGEN_VERSION}/eigen-${EIGEN_VERSION}.tar.gz
EIGEN_BASENAME=eigen-${EIGEN_VERSION}

EIGEN_INCLUDE=${EIGEN_BASENAME}-server-install/include

if [[ -d ${EIGEN_BASENAME}-server-install ]] ; then
  log "Eigen already installed."
else
  log "Retrieving Eigen."

  start=$(date +%s)
  wget ${EIGEN_REPO}
  end=$(date +%s)
  echo "Elapsed Time downloading from eigen repo: $(($end-$start)) seconds"

  log "Extracting Eigen."
  start=$(date +%s)
  tar -xzf ${EIGEN_BASENAME}.tar.gz

  end=$(date +%s)
  echo "Elapsed Time Extracting EIGEN: $(($end-$start)) seconds"

  mv ${EIGEN_BASENAME} ${EIGEN_BASENAME}-source
  mkdir -p ${EIGEN_INCLUDE}/unsupported
  mv ${EIGEN_BASENAME}-source/Eigen ${EIGEN_INCLUDE}
  mv ${EIGEN_BASENAME}-source/unsupported/Eigen ${EIGEN_INCLUDE}/unsupported/Eigen

  rm -Rf ${EIGEN_BASENAME}.tar.gz
  rm -Rf ${EIGEN_BASENAME}-source
fi

cp -p -r ${EIGEN_INCLUDE}/* ${LIBCARLA_INSTALL_SERVER_FOLDER}/include/


if ${USE_CHRONO} ; then

  # ==============================================================================
  # -- Get Eigen headers (Chrono dependency) -------------------------------------
  # ==============================================================================

  EIGEN_VERSION=3.3.7
  EIGEN_REPO=https://gitlab.com/libeigen/eigen/-/archive/3.3.7/eigen-3.3.7.tar.gz
  EIGEN_BASENAME=eigen-${EIGEN_VERSION}

  EIGEN_INCLUDE=${EIGEN_BASENAME}-server-install/include

  if [[ -d ${EIGEN_BASENAME}-server-install ]] ; then
    log "Eigen already installed."
  else
    log "Retrieving Eigen."

    start=$(date +%s)
    wget ${EIGEN_REPO}
    end=$(date +%s)
    echo "Elapsed Time: $(($end-$start)) seconds"

    log "Extracting Eigen."

    start=$(date +%s)
    tar -xzf ${EIGEN_BASENAME}.tar.gz
    end=$(date +%s)
    echo "Elapsed Time Extracting for Eigen: $(($end-$start)) seconds"

    mv ${EIGEN_BASENAME} ${EIGEN_BASENAME}-source
    mkdir -p ${EIGEN_INCLUDE}/unsupported
    mv ${EIGEN_BASENAME}-source/Eigen ${EIGEN_INCLUDE}
    mv ${EIGEN_BASENAME}-source/unsupported/Eigen ${EIGEN_INCLUDE}/unsupported/Eigen

    rm -Rf ${EIGEN_BASENAME}.tar.gz
    rm -Rf ${EIGEN_BASENAME}-source

    cp -p -r ${EIGEN_INCLUDE}/* ${LIBCARLA_INSTALL_SERVER_FOLDER}/include/
  fi


  # ==============================================================================
  # -- Get Chrono and compile it for server (libc++) -------------------------------------
  # ==============================================================================

  CHRONO_TAG=6.0.0
  # CHRONO_TAG=develop
  CHRONO_REPO=https://github.com/projectchrono/chrono.git
  CHRONO_BASENAME=chrono

  CHRONO_SRC_DIR=chrono-source
  CHRONO_INSTALL_CLIENT_DIR=chrono-install

  if [[ -d ${CHRONO_BASENAME}-server-install ]] ; then
    log "chrono library already installed."
  else
    log "Retrieving chrono library."
    start=$(date +%s)
    git clone --depth 1 --branch ${CHRONO_TAG} ${CHRONO_REPO} ${CHRONO_BASENAME}-source
    end=$(date +%s)
    echo "Elapsed Time dowloading chrono: $(($end-$start)) seconds"

    mkdir -p ${CHRONO_BASENAME}-server-build
    pushd ${CHRONO_SRC_DIR}/server-build >/dev/null
    cmake -G "Ninja" \
        -DCMAKE_CXX_FLAGS="-Wno-unused-command-line-argument" \
        -DCMAKE_INSTALL_PREFIX="../${CHRONO_BASENAME}-server-install" \
        -DCMAKE_TOOLCHAIN_FILE="${LIBCPP_TOOLCHAIN_FILE}" \
        -DCMAKE_BUILD_TYPE=Release \
        -DENABLE_MODULE_VEHICLE=ON \
        -DEIGEN3_INCLUDE_DIR="../../${EIGEN_INCLUDE}" \
        ..
    ninja
    ninja install
    popd >/dev/null

    rm -Rf ${CHRONO_SRC_DIR}
  fi

  cp -p ${CHRONO_INSTALL_CLIENT_DIR}/lib/*.a ${LIBCARLA_INSTALL_SERVER_FOLDER}/lib/
  cp -p -r ${CHRONO_INSTALL_CLIENT_DIR}/include/* ${LIBCARLA_INSTALL_SERVER_FOLDER}/include/
fi

# ==============================================================================
# -- Get and compile Sqlite3 ---------------------------------------------------
# ==============================================================================

SQLITE_VERSION=sqlite-autoconf-3340100
SQLITE_REPO=https://www.sqlite.org/2021/${SQLITE_VERSION}.tar.gz
SQLITE_TAR=${SQLITE_VERSION}.tar.gz
SQLITE_BASENAME=sqlite

SQLITE_CLIENT_INCLUDE_DIR=${PWD}/${SQLITE_BASENAME}-client-install/include
SQLITE_CLIENT_LIB=${PWD}/${SQLITE_BASENAME}-client-install/lib/libsqlite3.a
SQLITE_EXE=${PWD}/${SQLITE_BASENAME}-client-install/bin/sqlite3

SQLITE_SERVER_INCLUDE_DIR=${PWD}/${SQLITE_BASENAME}-server-install/include
SQLITE_SERVER_LIB=${PWD}/${SQLITE_BASENAME}-server-install/lib/libsqlite3.a

if [[ -d ${SQLITE_BASENAME}-client-install &&  -d ${SQLITE_BASENAME}-server-install ]] ; then
  log "Sqlite already installed."
else
  rm -Rf \
      ${SQLITE_BASENAME}-source \
      ${SQLITE_BASENAME}-server-build ${SQLITE_BASENAME}-client-build \
      ${SQLITE_BASENAME}-server-install ${SQLITE_BASENAME}-client-install

  log "Retrieving Sqlite3"

  start=$(date +%s)
  wget ${SQLITE_REPO}
  end=$(date +%s)
  echo "Elapsed Time: $(($end-$start)) seconds"

  log "Extracting Sqlite3"

  start=$(date +%s)
  tar -xzf ${SQLITE_TAR}
  end=$(date +%s)
  echo "Elapsed Time Extracting for SQlite: $(($end-$start)) seconds"

  mv ${SQLITE_VERSION} ${SQLITE_BASENAME}-source

  mkdir ${SQLITE_BASENAME}-client-build
  pushd ${SQLITE_BASENAME}-client-build >/dev/null
  ../${SQLITE_BASENAME}-source/configure CFLAGS="-fPIC -w" --prefix=${PWD}/../${SQLITE_BASENAME}-client-install/
  make
  make install
  popd >/dev/null

  mkdir ${SQLITE_BASENAME}-server-build
  pushd ${SQLITE_BASENAME}-server-build >/dev/null
  ../${SQLITE_BASENAME}-source/configure CFLAGS="-fPIC -w ${UNREAL_HOSTED_CFLAGS}" LDFLAGS="${UNREAL_HOSTED_LINKER_FLAGS}" --prefix=${PWD}/../${SQLITE_BASENAME}-server-install/
  make
  make install
  popd >/dev/null

  rm -Rf ${SQLITE_TAR}
  rm -Rf ${SQLITE_BASENAME}-source ${SQLITE_BASENAME}-server-build ${SQLITE_BASENAME}-client-build
fi

cp ${SQLITE_CLIENT_LIB} ${LIBCARLA_INSTALL_CLIENT_FOLDER}/lib/
cp -p -r ${SQLITE_SERVER_LIB}* ${LIBCARLA_INSTALL_SERVER_FOLDER}/lib/

# ==============================================================================
# -- Get and compile PROJ ------------------------------------------------------
# ==============================================================================

PROJ_VERSION=proj-7.2.1
PROJ_REPO=https://download.osgeo.org/proj/${PROJ_VERSION}.tar.gz

PROJ_TAR=${PROJ_VERSION}.tar.gz
PROJ_BASENAME=proj
PROJ_CLIENT_LIB=${PROJ_BASENAME}-client-install/lib/libproj.a
PROJ_SERVER_LIB=${PROJ_BASENAME}-server-install/lib/libproj.a

if [[ -d ${PROJ_BASENAME}-client-install && -d ${PROJ_BASENAME}-server-install ]] ; then
  log "PROJ already installed."
else
  rm -Rf \
      ${PROJ_BASENAME}-source \
      ${PROJ_BASENAME}-server-build ${PROJ_BASENAME}-client-build \
      ${PROJ_BASENAME}-server-install ${PROJ_BASENAME}-client-install

  log "Retrieving PROJ"

  start=$(date +%s)
  wget ${PROJ_REPO}
  end=$(date +%s)
  echo "Elapsed Time: $(($end-$start)) seconds"

  log "Extracting PROJ"
  start=$(date +%s)
  tar -xzf ${PROJ_TAR}
  end=$(date +%s)
  echo "Elapsed Time Extracting for PROJ: $(($end-$start)) seconds"

  mv ${PROJ_VERSION} ${PROJ_BASENAME}-source

  mkdir -p ${PROJ_BASENAME}-client-build
  pushd ${PROJ_BASENAME}-client-build >/dev/null
  cmake -G "Ninja" \
      -DCMAKE_C_FLAGS="-fPIC" \
      -DCMAKE_CXX_FLAGS="-std=c++17 -fPIC" \
      -DSQLITE3_INCLUDE_DIR=${SQLITE_CLIENT_INCLUDE_DIR} -DSQLITE3_LIBRARY=${SQLITE_CLIENT_LIB} \
      -DEXE_SQLITE3=${SQLITE_EXE} \
      -DENABLE_TIFF=OFF -DENABLE_CURL=OFF -DBUILD_SHARED_LIBS=OFF -DBUILD_PROJSYNC=OFF \
      -DCMAKE_BUILD_TYPE=Release -DBUILD_PROJINFO=OFF \
      -DBUILD_CCT=OFF -DBUILD_CS2CS=OFF -DBUILD_GEOD=OFF -DBUILD_GIE=OFF \
      -DBUILD_PROJ=OFF -DBUILD_TESTING=OFF \
      -DCMAKE_INSTALL_PREFIX=../${PROJ_BASENAME}-client-install \
      ../${PROJ_BASENAME}-source
  ninja
  ninja install
  popd >/dev/null

  mkdir -p ${PROJ_BASENAME}-server-build
  pushd ${PROJ_BASENAME}-server-build >/dev/null
  cmake -G "Ninja" \
      -DCMAKE_INSTALL_PREFIX=../${PROJ_BASENAME}-server-install \
      -DCMAKE_TOOLCHAIN_FILE="${LIBCPP_TOOLCHAIN_FILE}" \
      -DSQLITE3_INCLUDE_DIR=${SQLITE_SERVER_INCLUDE_DIR} -DSQLITE3_LIBRARY=${SQLITE_SERVER_LIB} \
      -DEXE_SQLITE3=${SQLITE_EXE} \
      -DENABLE_TIFF=OFF -DENABLE_CURL=OFF -DBUILD_SHARED_LIBS=OFF -DBUILD_PROJSYNC=OFF \
      -DCMAKE_BUILD_TYPE=Release -DBUILD_PROJINFO=OFF \
      -DBUILD_CCT=OFF -DBUILD_CS2CS=OFF -DBUILD_GEOD=OFF -DBUILD_GIE=OFF \
      -DBUILD_PROJ=OFF -DBUILD_TESTING=OFF \
      ../${PROJ_BASENAME}-source
  ninja
  ninja install
  popd >/dev/null

  rm -Rf ${PROJ_TAR}
  rm -Rf ${PROJ_BASENAME}-source ${PROJ_BASENAME}-client-build ${PROJ_BASENAME}-server-build

fi

cp ${PROJ_CLIENT_LIB} ${LIBCARLA_INSTALL_CLIENT_FOLDER}/lib/
cp -p ${PROJ_SERVER_LIB} ${LIBCARLA_INSTALL_SERVER_FOLDER}/lib/

# ==============================================================================
# -- Get and compile patchelf --------------------------------------------------
# ==============================================================================

PATCHELF_VERSION=0.12
PATCHELF_REPO=https://github.com/NixOS/patchelf/archive/${PATCHELF_VERSION}.tar.gz

PATCHELF_TAR=${PATCHELF_VERSION}.tar.gz
PATCHELF_SRC_DIR=patchelf-src
PATCHELF_INSTALL_CLIENT_DIR=patchelf-install

PATCHELF_INCLUDE_DIR=${PWD}/${PATCHELF_INSTALL_CLIENT_DIR}/include
PATCHELF_EXE=${PWD}/${PATCHELF_INSTALL_CLIENT_DIR}/bin/patchelf

if [[ -d ${PATCHELF_INSTALL_CLIENT_DIR} ]] ; then
  log "Patchelf already installed."
else
  log "Retrieving patchelf"

  start=$(date +%s)
  wget ${PATCHELF_REPO}
  end=$(date +%s)
  echo "Elapsed Time: $(($end-$start)) seconds"

  log "Extracting patchelf"
  start=$(date +%s)
  tar -xzf ${PATCHELF_TAR}
  end=$(date +%s)
  echo "Elapsed Time Extracting patchelf: $(($end-$start)) seconds"

  mv patchelf-${PATCHELF_VERSION} ${PATCHELF_SRC_DIR}

  mkdir ${PATCHELF_INSTALL_CLIENT_DIR}

  pushd ${PATCHELF_SRC_DIR} >/dev/null

  ./bootstrap.sh
  ./configure --prefix=${PWD}/../${PATCHELF_INSTALL_CLIENT_DIR}
  make
  make install

  popd >/dev/null

  rm -Rf ${PATCHELF_TAR}
  rm -Rf ${PATCHELF_SRC_DIR}
fi

cp ${PATCHELF_EXE} ${LIBCARLA_INSTALL_CLIENT_FOLDER}/bin/

# ==============================================================================
# -- Download libtorch and dependencies ----------------------------------------
# ==============================================================================

if ${USE_PYTORCH} ; then

  LIBTORCH_BASENAME=libtorch

  LIBTORCH_PATH=${PWD}/${LIBTORCH_BASENAME}
  LIBTORCH_INCLUDE=${LIBTORCH_PATH}/include
  LIBTORCH_LIB=${LIBTORCH_PATH}/lib
  LIBTORCH_ZIPFILE=libtorch-shared-with-deps-1.11.0+cu113.zip
  LIBTORCH_REPO=https://download.pytorch.org/libtorch/cu113/libtorch-shared-with-deps-1.11.0%2Bcu113.zip
  if [[ ! -d ${LIBTORCH_PATH} ]] ; then

    start=$(date +%s)
    wget ${LIBTORCH_REPO}
    end=$(date +%s)
    echo "Elapsed Time downloading LIBTORCH_REPO: $(($end-$start)) seconds"

    unzip ${LIBTORCH_ZIPFILE}
  fi

  function build_torch_extension {

    LIB_SOURCE=$1
    LIB_INSTALL=$2
    LIB_REPO=$3
    if [[ ! -d ${LIB_INSTALL} ]] ; then
      if [[ ! -d ${LIB_SOURCE} ]] ; then
        mkdir -p ${LIB_SOURCE}
        log "${LIB_REPO}"
        git clone ${LIB_REPO} ${LIB_SOURCE}
        mkdir -p ${LIB_SOURCE}/build
      fi
      pushd ${LIB_SOURCE}/build >/dev/null

      cmake -DCMAKE_PREFIX_PATH="${LIBTORCH_PATH}" \
          -DCMAKE_CUDA_COMPILER="/usr/local/cuda/bin/nvcc" \
          -DCMAKE_INSTALL_PREFIX="${LIB_INSTALL}" \
          -DCMAKE_CUDA_FLAGS="-gencode=arch=compute_35,code=sm_35 -gencode=arch=compute_37,code=sm_37 -gencode=arch=compute_50,code=sm_50 -gencode=arch=compute_52,code=sm_52 -gencode=arch=compute_53,code=sm_53 -gencode=arch=compute_60,code=sm_60 -gencode=arch=compute_61,code=sm_61 -gencode=arch=compute_62,code=sm_62 -gencode=arch=compute_70,code=sm_70 -gencode=arch=compute_72,code=sm_72 -gencode=arch=compute_75,code=sm_75 -gencode=arch=compute_80,code=sm_80 -gencode=arch=compute_86,code=sm_86 -gencode=arch=compute_87,code=sm_87 -Wno-deprecated-gpu-targets" \
          -DWITH_CUDA=ON \
          ..
      make
      make install
      popd >/dev/null
    fi

  }

  log "Build libtorch scatter"
  #LibtorchScatter
  LIBTORCHSCATTER_BASENAME=libtorchscatter
  LIBTORCHSCATTER_SRC_DIR=${PWD}/${LIBTORCHSCATTER_BASENAME}-source
  LIBTORCHSCATTER_INSTALL_CLIENT_DIR=${PWD}/${LIBTORCHSCATTER_BASENAME}-install
  LIBTORCHSCATTER_INCLUDE=${LIBTORCHSCATTER_INSTALL_CLIENT_DIR}/include
  LIBTORCHSCATTER_LIB=${LIBTORCHSCATTER_INSTALL_CLIENT_DIR}/lib
  LIBTORCHSCATTER_REPO="https://github.com/rusty1s/pytorch_scatter.git"

  build_torch_extension ${LIBTORCHSCATTER_SRC_DIR} ${LIBTORCHSCATTER_INSTALL_CLIENT_DIR} "${LIBTORCHSCATTER_REPO}"

  log "Build libtorch cluster"
  LIBTORCHCLUSTER_BASENAME=libtorchcluster
  LIBTORCHCLUSTER_SRC_DIR=${PWD}/${LIBTORCHCLUSTER_BASENAME}-source
  LIBTORCHCLUSTER_INSTALL_CLIENT_DIR=${PWD}/${LIBTORCHCLUSTER_BASENAME}-install
  LIBTORCHCLUSTER_INCLUDE=${LIBTORCHCLUSTER_INSTALL_CLIENT_DIR}/include
  LIBTORCHCLUSTER_LIB=${LIBTORCHCLUSTER_INSTALL_CLIENT_DIR}/lib
  LIBTORCHCLUSTER_REPO="https://github.com/rusty1s/pytorch_cluster.git"

  build_torch_extension ${LIBTORCHCLUSTER_SRC_DIR} ${LIBTORCHCLUSTER_INSTALL_CLIENT_DIR} "${LIBTORCHCLUSTER_REPO}"

  cp -p ${LIBTORCH_LIB}/*.a ${LIBCARLA_INSTALL_SERVER_FOLDER}/lib/
  cp -p ${LIBTORCH_LIB}/*.so* ${LIBCARLA_INSTALL_SERVER_FOLDER}/lib/
  cp -p ${LIBTORCHSCATTER_LIB}/*.so* ${LIBCARLA_INSTALL_SERVER_FOLDER}/lib/
  cp -p ${LIBTORCHCLUSTER_LIB}/*.so* ${LIBCARLA_INSTALL_SERVER_FOLDER}/lib/

  mkdir -p ${CARLAUE4_PLUGIN_ROOT_FOLDER}/Binaries/Linux/
  cp -p ${LIBTORCH_LIB}/*.so* ${CARLAUE4_PLUGIN_ROOT_FOLDER}/Binaries/Linux/
  cp -p ${LIBTORCHSCATTER_LIB}/*.so* ${CARLAUE4_PLUGIN_ROOT_FOLDER}/Binaries/Linux/
  cp -p ${LIBTORCHCLUSTER_LIB}/*.so* ${CARLAUE4_PLUGIN_ROOT_FOLDER}/Binaries/Linux/
fi


# ==============================================================================
# -- Download Fast DDS and dependencies ----------------------------------------
# ==============================================================================

FASTDDS_BASENAME=${PWD}/fast-dds
FASTDDS_SERVER_INCLUDE=${FASTDDS_BASENAME}-server-install/include
FASTDDS_SERVER_LIB=${FASTDDS_BASENAME}-server-install/lib
if ${USE_ROS2} ; then
  if [[ -d ${FASTDDS_BASENAME}-server-install ]] ; then
    log "FastDDS already installed."
  else
    rm -Rf \
        ${FASTDDS_BASENAME}-source \
        ${FASTDDS_BASENAME}-server-build \
        ${FASTDDS_BASENAME}-server-install
    mkdir -p ${FASTDDS_BASENAME}-server-install/lib

    log "Build fast dds"
    FAST_DDS_LIB_REPO="https://github.com/eProsima/Fast-DDS.git"
    FAST_DDS_LIB_BRANCH=2.11.2
    # dependency foonath is not a submodule
    FOONATHAN_MEMORY_VENDOR_REPO="https://github.com/eProsima/foonathan_memory_vendor.git"
    FOONATHAN_MEMORY_VENDOR_BRANCH=master
    FOONATHAN_MEMORY_VENDOR_SRC_DIR=${FASTDDS_BASENAME}-source/thirdparty/foonathan-memory-vendor

    mkdir -p ${FASTDDS_BASENAME}-server-build

    log "Prepare fast dds sources"
    git clone --depth 1 --branch ${FAST_DDS_LIB_BRANCH} ${FAST_DDS_LIB_REPO} ${FASTDDS_BASENAME}-source
    pushd ${FASTDDS_BASENAME}-source >/dev/null
    git submodule update --init
    git clone --depth 1 --branch ${FOONATHAN_MEMORY_VENDOR_BRANCH} ${FOONATHAN_MEMORY_VENDOR_REPO} ${FOONATHAN_MEMORY_VENDOR_SRC_DIR}

    # we have to tweak the sources a bit to be able to compile with our boost version AND without exceptions
    if [[ -e ${FASTDDS_BASENAME}-source/thirdparty/boost/include/boost ]]; then
      # remove their boost includes, but keep their entry point
      rm -rf ${FASTDDS_BASENAME}-source/thirdparty/boost/include/boost
      # ensure the find boost compiles without exceptions
      sed -i s/"CXX_STANDARD 11"/"CXX_STANDARD 11\n         COMPILE_DEFINITIONS \"-DBOOST_NO_EXCEPTIONS\""/ ${FASTDDS_BASENAME}-source/cmake/modules/FindThirdpartyBoost.cmake
      sed -i s/"class ThirdpartyBoostCompileTest"/"#ifdef BOOST_NO_EXCEPTIONS\nnamespace boost {void throw_exception(std::exception const \& e) {}}\n#endif\nclass ThirdpartyBoostCompileTest"/ ${FASTDDS_BASENAME}-source/thirdparty/boost/test/ThirdpartyBoostCompile_test.cpp
    fi
    popd >/dev/null

    log "fast dds: Build asio"
    pushd ${FASTDDS_BASENAME}-source/thirdparty/asio/asio
    ./autogen.sh
    popd >/dev/null
    mkdir -p ${FASTDDS_BASENAME}-server-build/asio
    pushd ${FASTDDS_BASENAME}-server-build/asio >/dev/null
    # since ASIO is header only installation, we don't care about flags from LIBCPP_TOOLCHAIN_FILE (let the tests etc. build on host settings for now...)
    ${FASTDDS_BASENAME}-source/thirdparty/asio/asio/configure --prefix="${FASTDDS_BASENAME}-server-install"
    make -j 15 install
    popd >/dev/null

    log "fast dds: Build foonathan memory vendor"
    mkdir -p ${FASTDDS_BASENAME}-server-build/foonathan-memory-vendor
    pushd ${FASTDDS_BASENAME}-server-build/foonathan-memory-vendor >/dev/null
    cmake -G "Ninja" \
      -DCMAKE_INSTALL_PREFIX="${FASTDDS_BASENAME}-server-install" \
      -DCMAKE_TOOLCHAIN_FILE="${LIBCPP_TOOLCHAIN_FILE}" \
      ${FASTDDS_BASENAME}-source/thirdparty/foonathan-memory-vendor
    ninja
    ninja install
    popd >/dev/null

    log "fast dds: Copy OpenSSL from UE4"
    cp -r ${UE4_ROOT}/Engine/Source/ThirdParty/OpenSSL/1.1.1c/include/Linux/x86_64-unknown-linux-gnu/* ${FASTDDS_BASENAME}-server-install/include
    cp -r ${UE4_ROOT}/Engine/Source/ThirdParty/OpenSSL/1.1.1c/lib/Linux/x86_64-unknown-linux-gnu/* ${FASTDDS_BASENAME}-server-install/lib

    log "fast dds: Build fast dds itself"
    mkdir -p ${FASTDDS_BASENAME}-server-build/fastdds
    pushd ${FASTDDS_BASENAME}-server-build/fastdds >/dev/null

    cmake -G "Ninja" \
      -DCMAKE_INSTALL_PREFIX="${FASTDDS_BASENAME}-server-install" \
      -DCMAKE_TOOLCHAIN_FILE="${LIBCPP_TOOLCHAIN_FILE}" \
      -DCMAKE_MODULE_PATH="${FASTDDS_BASENAME}-server-install" \
      -DBUILD_TESTING=OFF \
      -DCOMPILE_EXAMPLES=OFF \
      -DCOMPILE_TOOLS=OFF \
      -DTHIRDPARTY_Asio=FORCE \
      -DTHIRDPARTY_fastcdr=FORCE \
      -DTHIRDPARTY_TinyXML2=FORCE \
      -DOPENSSL_FOUND:BOOL=ON \
      -DOPENSSL_INCLUDE_DIR:FILEPATH=${FASTDDS_BASENAME}-server-install/include \
      -DOPENSSL_SSL_LIBRARY:FILEPATH=${FASTDDS_BASENAME}-server-install/lib/libssl.a \
      -DOPENSSL_CRYPTO_LIBRARY:FILEPATH=${FASTDDS_BASENAME}-server-install/lib/libcrypto.a \
      -DCMAKE_CXX_FLAGS="-latomic" \
      -DTHIRDPARTY_BOOST_INCLUDE_DIR="${BOOST_INCLUDE};${FASTDDS_BASENAME}-source/thirdparty/boost/include" \
      ${FASTDDS_BASENAME}-source
    ninja
    ninja install
    popd >/dev/null

    rm -Rf ${FASTDDS_BASENAME}-source ${FASTDDS_BASENAME}-server-build
  fi

  cp -pr ${FASTDDS_SERVER_INCLUDE}/* ${LIBCARLA_INSTALL_SERVER_FOLDER}/include/
  cp -p ${FASTDDS_SERVER_LIB}/*.a ${LIBCARLA_INSTALL_SERVER_FOLDER}/lib/
fi


# -- CMAKE_CONFIG_FILE ---------------------------------------------------------

cat >${CMAKE_CONFIG_FILE}.gen <<EOL
# Automatically generated by `basename "$0"`

add_definitions(-DBOOST_ERROR_CODE_HEADER_ONLY)

if (CMAKE_BUILD_TYPE STREQUAL "Server")
  add_definitions(-DASIO_NO_EXCEPTIONS)
  add_definitions(-DBOOST_NO_EXCEPTIONS)
  add_definitions(-DLIBCARLA_NO_EXCEPTIONS)
  add_definitions(-DPUGIXML_NO_EXCEPTIONS)
endif ()

# Uncomment to force support for an specific image format (require their
# respective libraries installed).
# add_definitions(-DLIBCARLA_IMAGE_WITH_PNG_SUPPORT)
# add_definitions(-DLIBCARLA_IMAGE_WITH_JPEG_SUPPORT)
# add_definitions(-DLIBCARLA_IMAGE_WITH_TIFF_SUPPORT)

add_definitions(-DLIBCARLA_TEST_CONTENT_FOLDER="${LIBCARLA_TEST_CONTENT_FOLDER}")

set(BOOST_INCLUDE_PATH "${BOOST_INCLUDE}")

if (CMAKE_BUILD_TYPE STREQUAL "Server")
  # Here libraries linking libc++.
  set(ROS2_MW_INCLUDE_PATH "${FASTDDS_SERVER_INCLUDE}")
  set(ROS2_MW_LIB_PATH "${FASTDDS_SERVER_LIB}")
  set(ROS2_MW_LINK_LIBRARIES "fastrtps;fastcdr")
  set(ROS2_MW_NAME "fastdds")
  set(LLVM_INCLUDE_PATH "${LLVM_INCLUDE}")
  set(LLVM_LIB_PATH "${LLVM_LIBPATH}")
  set(RPCLIB_INCLUDE_PATH "${RPCLIB_SERVER_INCLUDE}")
  set(RPCLIB_LIB_PATH "${RPCLIB_SERVER_LIBPATH}")
  set(GTEST_INCLUDE_PATH "${GTEST_SERVER_INCLUDE}")
  set(GTEST_LIB_PATH "${GTEST_SERVER_LIBPATH}")
elseif (CMAKE_BUILD_TYPE STREQUAL "Pytorch")
  list(APPEND CMAKE_PREFIX_PATH "${LIBTORCH_PATH}")
  list(APPEND CMAKE_PREFIX_PATH "${LIBTORCHSCATTER_INSTALL_CLIENT_DIR}")
  list(APPEND CMAKE_PREFIX_PATH "${LIBTORCHCLUSTER_INSTALL_CLIENT_DIR}")
  list(APPEND CMAKE_PREFIX_PATH "${LIBTORCHSPARSE_INSTALL_CLIENT_DIR}")
elseif (CMAKE_BUILD_TYPE STREQUAL "Client")
  # Here libraries linking libstdc++.
  set(RPCLIB_INCLUDE_PATH "${RPCLIB_CLIENT_INCLUDE}")
  set(RPCLIB_LIB_PATH "${RPCLIB_CLIENT_LIBPATH}")
  set(GTEST_INCLUDE_PATH "${GTEST_CLIENT_INCLUDE}")
  set(GTEST_LIB_PATH "${GTEST_CLIENT_LIBPATH}")
  set(BOOST_LIB_PATH "${BOOST_LIBPATH}")
  set(RECAST_INCLUDE_PATH "${RECAST_CLIENT_INCLUDE}")
  set(RECAST_LIB_PATH "${RECAST_CLIENT_LIBPATH}")
  set(LIBPNG_INCLUDE_PATH "${LIBPNG_CLIENT_INCLUDE}")
  set(LIBPNG_LIB_PATH "${LIBPNG_CLIENT_LIBPATH}")
endif ()

EOL

if [ "${TRAVIS}" == "true" ] ; then
  log "Travis CI build detected: disabling PNG support."
  echo "add_definitions(-DLIBCARLA_IMAGE_WITH_PNG_SUPPORT=false)" >> ${CMAKE_CONFIG_FILE}.gen
else
  echo "add_definitions(-DLIBCARLA_IMAGE_WITH_PNG_SUPPORT=true)" >> ${CMAKE_CONFIG_FILE}.gen
fi

move_if_changed "${CMAKE_CONFIG_FILE}.gen" "${CMAKE_CONFIG_FILE}"

# ==============================================================================
# -- ...and we are done --------------------------------------------------------
# ==============================================================================

popd >/dev/null
log "Success!"
